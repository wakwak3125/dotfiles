# git worktree ヘルパーコマンド
# 使い方:
#   wt add <branch>            - 既存ブランチの worktree を作成
#   wt add -b <branch>         - 新しいブランチを作成して worktree を追加
#   wt rm <branch>             - worktree を削除
#   wt rm -b <branch>          - worktree とブランチを削除
#   wt list                    - worktree 一覧を表示
#   wt prune                   - リモート同期 + worktree の整理
#   wt clean                   - リモート同期 + マージ済みブランチ削除 + worktree の整理

local cmd=$1
shift

# git リポジトリ内でなければ終了
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "エラー: git リポジトリではありません" >&2
  return 1
fi

local repo_root=$(git rev-parse --show-toplevel)
local worktree_dir="$repo_root/worktrees"

case "$cmd" in
  add)
    local create_branch=false
    local branch_name=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -b|--branch)
          create_branch=true
          shift
          ;;
        *)
          branch_name=$1
          shift
          ;;
      esac
    done

    if [[ -z "$branch_name" ]]; then
      echo "使い方: wt add [-b] <branch>" >&2
      echo "  -b, --branch  新しいブランチを作成" >&2
      return 1
    fi

    # ディレクトリ名はブランチ名の最後の部分だけを使う (feature/login -> login)
    local dir_name="${branch_name##*/}"

    # worktrees ディレクトリがなければ作成
    mkdir -p "$worktree_dir"

    if [[ "$create_branch" == true ]]; then
      # 新しいブランチを作成して worktree を追加
      git worktree add -b "$branch_name" "$worktree_dir/$dir_name"
    else
      # 既存のブランチで worktree を追加
      git worktree add "$worktree_dir/$dir_name" "$branch_name"
    fi
    ;;

  rm|remove)
    local delete_branch=false
    local branch_name=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -b|--branch)
          delete_branch=true
          shift
          ;;
        *)
          branch_name=$1
          shift
          ;;
      esac
    done

    if [[ -z "$branch_name" ]]; then
      echo "使い方: wt rm [-b] <branch>" >&2
      echo "  -b, --branch  ブランチも削除" >&2
      return 1
    fi

    # ディレクトリ名はブランチ名の最後の部分だけを使う (feature/login -> login)
    local dir_name="${branch_name##*/}"
    local worktree_path="$worktree_dir/$dir_name"

    # worktree が存在するか確認
    if [[ ! -d "$worktree_path" ]]; then
      echo "エラー: worktree '$worktree_path' が見つかりません" >&2
      return 1
    fi

    # worktree を削除
    git worktree remove "$worktree_path"

    # -b オプションが指定された場合はブランチも削除
    if [[ "$delete_branch" == true ]]; then
      git branch -d "$branch_name" 2>/dev/null || git branch -D "$branch_name"
      echo "ブランチ '$branch_name' を削除しました"
    fi
    ;;

  list|ls)
    git worktree list
    ;;

  prune)
    # リモートと同期
    echo "リモートを同期中..."
    git fetch --prune

    # worktree の整理
    echo "worktree を整理中..."
    git worktree prune
    echo "完了"
    ;;

  clean)
    # リモートと同期
    echo "リモートを同期中..."
    git fetch --prune

    # マージ済みブランチを削除
    local merged_branches=$(git branch --merged | grep -v -E "^\*|^\s*(main|master|develop)$" | sed 's/^[ ]*//')

    if [[ -n "$merged_branches" ]]; then
      echo "マージ済みブランチを削除中..."
      echo "$merged_branches" | while read -r branch; do
        git branch -d "$branch" 2>/dev/null && echo "  削除: $branch"
      done
    else
      echo "削除対象のブランチはありません"
    fi

    # worktree の整理
    echo "worktree を整理中..."
    git worktree prune
    echo "完了"
    ;;

  *)
    echo "使い方: wt <command> [args]"
    echo ""
    echo "コマンド:"
    echo "  add <branch>            既存ブランチの worktree を作成"
    echo "  add -b <branch>         新しいブランチを作成して worktree を追加"
    echo "  rm <branch>             worktree を削除"
    echo "  rm -b <branch>          worktree とブランチを削除"
    echo "  list                    worktree 一覧を表示"
    echo "  prune                   リモート同期 + worktree の整理"
    echo "  clean                   リモート同期 + マージ済みブランチ削除 + worktree の整理"
    ;;
esac
