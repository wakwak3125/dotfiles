# git worktree helper command
# Usage:
#   wt add <branch>            - Create worktree for existing branch
#   wt add -b <branch> [base]  - Create worktree with new branch
#   wt rm <branch>             - Remove worktree only
#   wt rm -b <branch>          - Remove worktree and branch
#   wt list                    - List all worktrees

local cmd=$1
shift

# gitリポジトリ内でなければ終了
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "Error: Not a git repository" >&2
  return 1
fi

local repo_root=$(git rev-parse --show-toplevel)
local worktree_dir="$repo_root/worktrees"

case "$cmd" in
  add)
    local create_branch=false
    local branch_name=""
    local base_branch="HEAD"

    # オプション解析
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -b|--branch)
          create_branch=true
          shift
          ;;
        *)
          if [[ -z "$branch_name" ]]; then
            branch_name=$1
          else
            base_branch=$1
          fi
          shift
          ;;
      esac
    done

    if [[ -z "$branch_name" ]]; then
      echo "Usage: wt add [-b] <branch_name> [base_branch]" >&2
      echo "  -b, --branch  Create a new branch" >&2
      return 1
    fi

    # ディレクトリ名はブランチ名の最後の部分だけを使う (feature/login -> login)
    local dir_name="${branch_name##*/}"

    # worktrees ディレクトリがなければ作成
    mkdir -p "$worktree_dir"

    if [[ "$create_branch" == true ]]; then
      # 新しいブランチを作成して worktree を追加
      git worktree add -b "$branch_name" "$worktree_dir/$dir_name" "$base_branch"
    else
      # 既存のブランチで worktree を追加
      git worktree add "$worktree_dir/$dir_name" "$branch_name"
    fi
    ;;

  rm|remove)
    local delete_branch=false
    local branch_name=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -b|--branch)
          delete_branch=true
          shift
          ;;
        *)
          branch_name=$1
          shift
          ;;
      esac
    done

    if [[ -z "$branch_name" ]]; then
      echo "Usage: wt rm [-b] <branch_name>" >&2
      echo "  -b, --branch  Also delete the branch" >&2
      return 1
    fi

    # ディレクトリ名はブランチ名の最後の部分だけを使う (feature/login -> login)
    local dir_name="${branch_name##*/}"
    local worktree_path="$worktree_dir/$dir_name"

    # worktree が存在するか確認
    if [[ ! -d "$worktree_path" ]]; then
      echo "Error: Worktree '$worktree_path' not found" >&2
      return 1
    fi

    # worktree を削除
    git worktree remove "$worktree_path"

    # -b オプションが指定された場合はブランチも削除
    if [[ "$delete_branch" == true ]]; then
      git branch -d "$branch_name" 2>/dev/null || git branch -D "$branch_name"
      echo "Deleted branch '$branch_name'"
    fi
    ;;

  list|ls)
    git worktree list
    ;;

  *)
    echo "Usage: wt <command> [args]"
    echo ""
    echo "Commands:"
    echo "  add <branch>            Create worktree for existing branch"
    echo "  add -b <branch> [base]  Create worktree with new branch"
    echo "  rm <branch>             Remove worktree only"
    echo "  rm -b <branch>          Remove worktree and branch"
    echo "  list                    List all worktrees"
    ;;
esac
