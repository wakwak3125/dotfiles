# git worktree ヘルパーコマンド（tmux 統合付き）
# 使い方:
#   wt add <branch>            - 既存ブランチの worktree を作成（tmux window 自動作成）
#   wt add -b <branch>         - 新しいブランチを作成して worktree を追加（tmux window 自動作成）
#   wt rm <branch>             - worktree を削除（tmux window 自動削除）
#   wt rm -b <branch>          - worktree とブランチを削除（tmux window 自動削除）
#   wt list                    - worktree 一覧を表示
#   wt prune                   - リモート同期 + worktree の整理
#   wt clean                   - リモート同期 + マージ済みブランチ削除 + worktree の整理

local cmd=$1
shift

# git リポジトリ内でなければ終了
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "エラー: git リポジトリではありません" >&2
  return 1
fi

local repo_root=$(git rev-parse --show-toplevel)
local worktree_dir="$repo_root/worktrees"

# tmux 統合用の共通変数
local tmux_session=$(basename "$repo_root" | tr '.' '_')
local in_tmux=false
[[ -n "$TMUX" ]] && in_tmux=true

case "$cmd" in
  add)
    local create_branch=false
    local branch_name=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -b|--branch)
          create_branch=true
          shift
          ;;
        *)
          branch_name=$1
          shift
          ;;
      esac
    done

    if [[ -z "$branch_name" ]]; then
      echo "使い方: wt add [-b] <branch>" >&2
      echo "  -b, --branch  新しいブランチを作成" >&2
      return 1
    fi

    # ディレクトリ名はブランチ名の最後の部分だけを使う (feature/login -> login)
    local dir_name="${branch_name##*/}"

    # worktrees ディレクトリがなければ作成
    mkdir -p "$worktree_dir"

    if [[ "$create_branch" == true ]]; then
      # 新しいブランチを作成して worktree を追加
      git worktree add -b "$branch_name" "$worktree_dir/$dir_name"
    else
      # 既存のブランチで worktree を追加
      git worktree add "$worktree_dir/$dir_name" "$branch_name"
    fi

    # tmux 内なら window を自動作成
    if [[ "$in_tmux" == true ]] && [[ -d "$worktree_dir/$dir_name" ]]; then
      if ! tmux has-session -t "$tmux_session" 2>/dev/null; then
        tmux new-session -d -s "$tmux_session" -c "$worktree_dir/$dir_name" -n "$dir_name"
        tmux switch-client -t "$tmux_session:$dir_name"
      else
        tmux new-window -t "$tmux_session" -n "$dir_name" -c "$worktree_dir/$dir_name"
        local current_session=$(tmux display-message -p '#S')
        if [[ "$current_session" != "$tmux_session" ]]; then
          tmux switch-client -t "$tmux_session:$dir_name"
        else
          tmux select-window -t "$tmux_session:$dir_name"
        fi
      fi
    fi
    ;;

  rm|remove)
    local delete_branch=false
    local branch_name=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -b|--branch)
          delete_branch=true
          shift
          ;;
        *)
          branch_name=$1
          shift
          ;;
      esac
    done

    if [[ -z "$branch_name" ]]; then
      echo "使い方: wt rm [-b] <branch>" >&2
      echo "  -b, --branch  ブランチも削除" >&2
      return 1
    fi

    # ディレクトリ名はブランチ名の最後の部分だけを使う (feature/login -> login)
    local dir_name="${branch_name##*/}"
    local worktree_path="$worktree_dir/$dir_name"

    # worktree が存在するか確認
    if [[ ! -d "$worktree_path" ]]; then
      echo "エラー: worktree '$worktree_path' が見つかりません" >&2
      return 1
    fi

    # tmux window の削除判定
    local kill_window_after=false
    if [[ "$in_tmux" == true ]] && tmux has-session -t "$tmux_session" 2>/dev/null; then
      local current_window=$(tmux display-message -p '#W')
      if [[ "$current_window" == "$dir_name" ]]; then
        # 現在のウィンドウなので worktree 削除後に kill
        kill_window_after=true
      else
        # 別のウィンドウなので先に kill
        tmux kill-window -t "$tmux_session:$dir_name" 2>/dev/null
      fi
    fi

    # worktree を削除
    git worktree remove "$worktree_path"

    # -b オプションが指定された場合はブランチも削除
    if [[ "$delete_branch" == true ]]; then
      git branch -d "$branch_name" 2>/dev/null || git branch -D "$branch_name"
      echo "ブランチ '$branch_name' を削除しました"
    fi

    # 遅延 window 削除
    if [[ "$kill_window_after" == true ]]; then
      tmux kill-window -t "$tmux_session:$dir_name" 2>/dev/null
    fi
    ;;

  list|ls)
    git worktree list
    ;;

  prune)
    # リモートと同期
    echo "リモートを同期中..."
    git fetch --prune

    # worktree の整理
    echo "worktree を整理中..."
    git worktree prune
    echo "完了"
    ;;

  clean)
    # リモートと同期
    echo "リモートを同期中..."
    git fetch --prune

    # ブランチ→worktree パスのマップを構築
    local -A branch_wt_map
    local _wt_path="" _wt_branch=""
    while IFS= read -r line; do
      if [[ "$line" == "worktree "* ]]; then
        _wt_path="${line#worktree }"
      elif [[ "$line" == "branch "* ]]; then
        _wt_branch="${line#branch refs/heads/}"
      elif [[ -z "$line" ]]; then
        if [[ -n "$_wt_branch" && -n "$_wt_path" ]]; then
          branch_wt_map[$_wt_branch]="$_wt_path"
        fi
        _wt_path=""
        _wt_branch=""
      fi
    done < <(git worktree list --porcelain; echo "")

    # 削除対象のブランチを収集（重複排除）
    local -aU delete_targets

    # 1. main/master/develop のいずれかにマージ済みのブランチ
    for base in main master develop; do
      git show-ref --verify --quiet "refs/heads/$base" 2>/dev/null || continue
      while IFS= read -r b; do
        delete_targets+=("$b")
      done < <(git branch --merged "$base" | grep -v -E "^\*|^\s*(main|master|develop)$" | sed 's/^[ ]*//')
    done

    # 2. リモートで削除済み（gone）のブランチ
    while IFS= read -r b; do
      delete_targets+=("$b")
    done < <(git branch -vv | grep ': gone]' | awk '{print $1}' | grep -v -E "^\s*(main|master|develop)$")

    if (( ${#delete_targets[@]} > 0 )); then
      echo "不要ブランチを削除中..."
      for branch in "${delete_targets[@]}"; do
        local wt_for_branch="${branch_wt_map[$branch]}"
        if [[ -n "$wt_for_branch" && -d "$wt_for_branch" ]]; then
          # tmux window を閉じる
          if [[ "$in_tmux" == true ]] && tmux has-session -t "$tmux_session" 2>/dev/null; then
            local wt_dir_name=$(basename "$wt_for_branch")
            tmux kill-window -t "$tmux_session:$wt_dir_name" 2>/dev/null
          fi
          # worktree を削除（未コミット変更があれば拒否される）
          if git worktree remove "$wt_for_branch" 2>/dev/null; then
            echo "  worktree 削除: $wt_for_branch"
          else
            echo "  スキップ（未コミット変更あり）: $wt_for_branch" >&2
            continue
          fi
        fi
        git branch -d "$branch" 2>/dev/null || git branch -D "$branch" 2>/dev/null
        echo "  ブランチ削除: $branch"
      done
    else
      echo "削除対象のブランチはありません"
    fi

    # worktree の整理
    echo "worktree を整理中..."
    git worktree prune
    echo "完了"
    ;;

  *)
    echo "使い方: wt <command> [args]"
    echo ""
    echo "コマンド:"
    echo "  add <branch>            既存ブランチの worktree を作成"
    echo "  add -b <branch>         新しいブランチを作成して worktree を追加"
    echo "  rm <branch>             worktree を削除"
    echo "  rm -b <branch>          worktree とブランチを削除"
    echo "  list                    worktree 一覧を表示"
    echo "  prune                   リモート同期 + worktree の整理"
    echo "  clean                   リモート同期 + マージ済みブランチ削除 + worktree の整理"
    ;;
esac
